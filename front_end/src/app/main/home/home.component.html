<div class="home">
  <div class="row">
    <div class="card">
      <div class="title">
        <h5>Live Sensor</h5>
      </div>
      <div class="body">
        <div class="data">
          <ul>
            <li *ngFor="let msg of messages">
              <strong>{{ msg.device_id }}</strong> ({{
                msg.application_id
              }})<br />
              üïí {{ msg.timestamp | date : "medium" }}<br />
              üîã Battery: {{ msg.battery ?? "N/A" }} V<br />
              üå°Ô∏è Temp: {{ msg.temperature ?? "N/A" }} ¬∞C<br />
              üíß Humidity: {{ msg.humidity ?? "N/A" }} %<br />
              üìç Location:
              {{ msg.location?.latitude ?? "N/A" }},
              {{ msg.location?.longitude ?? "N/A" }}
            </li>
          </ul>
        </div>
        <div class="connection-status">
          <h3 class="status {{ status }}">Websocket: {{ status }}</h3>
          <span
            class="retry"
            *ngIf="status === 'disconnected'"
            (click)="reconnectService()"
          >
            <ng-container *ngIf="reconnectStatus === 'Reconnecting...'">
              <i class="spinner-icon"></i>
            </ng-container>
            {{ reconnectStatus }}
          </span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="title">
        <h5>SHM Measurements</h5>
      </div>
      <div class="body">
        <section>
          <h4>SHM Level Classification Overview:</h4>
          <p>
            Structural Health Monitoring (SHM) levels provide a quantitative
            measure of the integrity and performance of a structure over time.
            These levels are expressed as percentages, representing the degree
            of stress, strain, or degradation relative to the system's designed
            capacity. The classification helps engineers and operators assess
            safety margins and determine when maintenance or intervention is
            required.
          </p>
        </section>

        <table
          class="min-w-full border border-gray-300 rounded-lg text-sm text-left"
        >
          <thead class="bg-gray-100 text-gray-700">
            <tr>
              <th class="px-4 py-2 border-b">SHM Level (%)</th>
              <th class="px-4 py-2 border-b">Zone</th>
              <th class="px-4 py-2 border-b">Description</th>
            </tr>
          </thead>
          <tbody>
            <tr class="bg-green-50">
              <td class="px-4 py-2 border-b">&lt; 50%</td>
              <td class="safe">Safe</td>
              <td class="px-4 py-2 border-b">
                Structure is operating well within safe limits.
              </td>
            </tr>
            <tr class="bg-yellow-50">
              <td class="px-4 py-2 border-b">50% ‚Äì 60%</td>
              <td class="moderate">Moderate</td>
              <td class="px-4 py-2 border-b">
                Slight increase in load or wear; still acceptable.
              </td>
            </tr>
            <tr class="bg-orange-50">
              <td class="px-4 py-2 border-b">60% ‚Äì 70%</td>
              <td class="elevated">Elevated</td>
              <td class="px-4 py-2 border-b">
                Noticeable stress; monitor for changes.
              </td>
            </tr>
            <tr class="bg-amber-100">
              <td class="px-4 py-2 border-b">70% ‚Äì 80%</td>
              <td class="high">High</td>
              <td class="px-4 py-2 border-b">
                Approaching critical thresholds; increased vigilance needed.
              </td>
            </tr>
            <tr class="bg-red-50">
              <td class="px-4 py-2 border-b">80% ‚Äì 90%</td>
              <td class="critical">Critical</td>
              <td class="px-4 py-2 border-b">
                High stress levels; prepare for possible intervention.
              </td>
            </tr>
            <tr class="bg-red-100">
              <td class="px-4 py-2">> 90%</td>
              <td class="emergency">Emergency</td>
              <td class="px-4 py-2">
                Immediate attention required; risk of failure or damage.
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="card" *ngFor="let vehicle of vehicles">
      <div class="title">
        <h5>{{ vehicle.name }}</h5>
      </div>
      <div class="body">
        <div class="ships">
          <div class="ship-container">
            <img
              [src]="getImageUrl(vehicle.image_path)"
              class="ship-image"
              alt="{{ vehicle.name }}"
            />
            <div class="grid-overlay"></div>
            <div
              *ngFor="let sensor of vehicle.end_devices"
              class="sensor-lamp"
              [style.left.%]="sensor.position_x"
              [style.top.%]="sensor.position_y"
              [ngClass]="getLampClass(sensor.last_data.value)"
            >
              <div class="tooltip">
                <a
                  class="device_id"
                  [routerLink]="['/sensors', sensor.device_id]"
                  >{{ sensor.device_id }}</a
                >
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="table-data">
    <div class="title">
      <h4>Data Sensor</h4>
    </div>
    <div class="body">
      <div class="info">
        <p>
          Sensor data refers to the real-time or logged measurements collected
          from embedded devices monitoring physical conditions. In your system,
          each data point typically includes:
        </p>
      </div>
      <div class="top-table">
        <div class="show-limit flex items-center gap-2">
          <label for="show">Show:</label>
          <select (change)="onPageSizeChange($event)">
            <option *ngFor="let size of [5, 10, 20, 50]" [value]="size">
              {{ size }}
            </option>
          </select>
          <label>Entries</label>
        </div>

        <div class="search flex items-center gap-2">
          <input
            type="text"
            placeholder="Search"
            [(ngModel)]="searchTerm"
            (input)="onSearch(searchTerm)"
            class="border px-2 py-1 rounded"
          />

          <fa-icon [icon]="faSearch"></fa-icon>
        </div>
      </div>
      <table class="sensor-table">
        <thead>
          <tr>
            <th>Device ID</th>
            <th>SHM</th>
            <th>Battery (V)</th>
            <th>Temp (¬∞C)</th>
            <th>Humidity (%)</th>
            <th>Spread Factor</th>
            <th>RSSI</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="isLoading">
            <td colspan="5" class="loading">Loading sensor data...</td>
          </tr>
          <tr *ngFor="let r of dataSensor">
            <td>
              <a class="device_id" [routerLink]="['/sensors', r.device_id]">{{
                r.device_id
              }}</a>
            </td>
            <td class="{{ getRangeClass(r.sensor_data?.Hum_SHT ?? 0) }}">
              {{ r.sensor_data?.Hum_SHT ?? "N/A" }}
            </td>
            <td>{{ r.sensor_data?.BatV ?? "N/A" }}</td>
            <td>
              {{ r.sensor_data?.TempC_SHT ?? "N/A" }}
              <span *ngIf="r.sensor_data?.TempC_SHT as temp">
                {{ getTempIcon(temp) }}
              </span>
            </td>
            <td>{{ r.sensor_data?.Hum_SHT ?? "N/A" }}</td>
            <td>
              {{
                r.raw_payload?.settings?.data_rate?.lora?.spreading_factor ??
                  "N/A"
              }}
            </td>
            <!-- <td>{{ r.latitude }}, {{ r.longitude }}</td> -->
            <td>{{ r.raw_payload?.rx_metadata?.[0]?.rssi ?? 'N/A' }}</td>
            <td>{{ r.timestamp | date : "medium" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
