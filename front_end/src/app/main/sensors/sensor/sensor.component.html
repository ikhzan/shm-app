<div class="sensors">
  <div class="title">
    <h3>Sensors</h3>
    <h4 (click)="toggleForm()">Add Sensor</h4>
    <h4 (click)="loadLora()" class="loading-lora" *ngIf="loadingLora != null">
      {{ loadingLora }}
    </h4>
  </div>

  <div class="sensor-form" *ngIf="formON">
    <form
      [formGroup]="deviceForm"
      (ngSubmit)="onSubmit()"
      class="form-group"
      enctype="multipart/form-data"
    >
      <div class="form-control">
        <label for="device_id">ID</label>
        <input
          id="device_id"
          class="form-input"
          type="text"
          formControlName="device_id"
          required
        />
        <div
          class="warning"
          *ngIf="
            deviceForm.get('device_id')?.touched &&
            deviceForm.get('device_id')?.hasError('required')
          "
        >
          Device ID is required.
        </div>
      </div>

      <div class="form-control">
        <label for="device_name">Name</label>
        <input
          id="device_name"
          class="form-input"
          type="text"
          formControlName="device_name"
          required
        />
      </div>

      <div class="form-control">
        <label for="dev_eui">Dev EUI</label>
        <input
          id="dev_eui"
          class="form-input"
          type="text"
          formControlName="dev_eui"
        />
      </div>

      <div class="form-control">
        <label for="join_eui">Join EUI</label>
        <input
          id="join_eui"
          class="form-input"
          type="text"
          formControlName="join_eui"
        />
      </div>

      <div class="form-control">
        <label for="position_x">Position X</label>
        <input
          id="position_x"
          class="form-input"
          type="number"
          formControlName="position_x"
          required
        />
      </div>

      <div class="form-control">
        <label for="position_y">Position Y</label>
        <input
          id="position_y"
          class="form-input"
          type="number"
          formControlName="position_y"
          required
        />
      </div>

      <div class="form-control">
        <label for="broker_id">Broker</label>
        <select
          id="broker_id"
          class="form-input"
          formControlName="broker_id"
          required
        >
          <option *ngFor="let broker of unattachedBrokers" [value]="broker.id">
            {{ broker.id }} - {{ broker.device_name }}
          </option>
        </select>
      </div>

      <div class="form-control">
        <label for="image_path">Image</label>
        <input
          id="image_path"
          class="form-input"
          type="file"
          (change)="onFileChange($event)"
        />
      </div>
      <div class="form-control">
        <input
          class="btn"
          type="submit"
          value="{{ isEditMode ? 'Update' : 'Create' }}"
        />
      </div>
    </form>

    <div class="image_container" *ngIf="imagePreview">
      <img [src]="imagePreview" class="image_preview" />
    </div>
  </div>

  <div class="sensor-grid">
    <div class="sensor-card" *ngFor="let sensor of allSensors">
      <div class="sensor-content">
        <img
          [src]="getImage(sensor.image_path)"
          alt="{{ sensor.device_name }}"
          class="sensor_img"
        />
      </div>

      <div class="sensor-footer">
        <div class="sensor-meta">
          <h3>
            <a
              class="device_id"
              [routerLink]="['/sensors', sensor.device_id]"
              >{{ sensor.device_name }}</a
            >
          </h3>
          <p>{{ sensor.device_id }}</p>
          <p>Broker: {{ sensor.broker?.device_name }}</p>
        </div>

        <div
          class="sensor-status"
          [ngClass]="getStatusClass(sensor.device_status)"
        >
          {{ sensor.device_status }}
        </div>

        <div class="sensor-actions" *ngIf="isAuthenticated">
          <button class="edit" (click)="editSensor(sensor.device_id)">
            Edit
          </button>
          <button class="delete" (click)="showDeleteModal(sensor.id)">
            Delete
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-delete-data-modal
  [visible]="modalDeleteON"
  [title]="'Delete Sensor'"
  [message]="'Are you sure you want to delete this item?'"
  (cancel)="closeDeleteModal()"
  (confirm)="deleteSensor()"
/>

<app-login-modal
  [visible]="loginModalON"
  (cancel)="closeLoginModal()"
  (login)="handleLogin($event)"
></app-login-modal>
